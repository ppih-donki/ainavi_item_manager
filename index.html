<!DOCTYPE html>
<html lang="ja">
<script>
// --- Minimal gatekeeper (24h localStorage token) ---
(function(){
  try {
    var k = 'aiNavSession';
    var raw = localStorage.getItem(k);
    var ok = false;
    if (raw) {
      try {
        var o = JSON.parse(raw);
        if (o && o.issuedAt && (Date.now() - o.issuedAt) <= 24*60*60*1000) ok = true;
      } catch(e){}
    }
    if (!ok) {
      // Prevent flashing content before redirect
      document.documentElement.style.display = 'none';
      location.replace('./login.html');
    } else {
      document.documentElement.style.display = '';
    }
  } catch(e) {
    // If storage unavailable, force login
    document.documentElement.style.display = 'none';
    location.replace('./login.html');
  }
})();
</script>
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
<meta name="robots" content="noindex,nofollow,noarchive,noimageindex" />
<meta charset="UTF-8" />
  <title>店舗マップビューア</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ツール名ヘッダー -->
  <div id="header">AI-MAP店舗商品管理システム</div>

  <!-- ローディング画面 -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">店舗・フロア情報を読み込み中...</div>
    </div>
  </div>

  <div id="controls">
    <div class="control-row">
      店舗:
      <select id="storeSelector">
        <option value="">店舗選択</option>
      </select>
      フロア:
      <select id="floorSelector">
        <option value="">フロア選択</option>
      </select>
      画像種別:
      <select id="imageTypeSelect">
        <option value="map">map</option>
        <option value="cad">cad</option>
      </select>
      <button id="refreshDataBtn" style="margin-left: 10px;">最新情報を取得</button>
    </div>
  </div>

  <div id="main">
    <!-- 左半分：マップ画面 -->
    <div id="leftSection">
      <div id="mapContainer"></div>
      <div id="zoom-controls">
        <button id="zoomInBtn">ズーム イン</button>
        <button id="zoomOutBtn">ズーム アウト</button>
        <button id="resetZoomBtn">リセット</button>
        <button id="toggleMarkersBtn">棚番号を非表示</button>
      </div>
    </div>
    
    <!-- 右半分：操作ボタンと商品一覧 -->
    <div id="rightSection">
      <!-- 右半分上部：操作ボタン -->
      <div id="controlsContainer">
        <div class="search-section">
          <input type="text" id="shelfSearchInput" placeholder="棚番号で検索 (例: 113)">
          <button id="searchBtn">検索</button>
          <button id="showAllMarkersBtn">全表示</button>
        </div>
        <div class="action-buttons">
          <button id="addProductBtn" class="add-btn">商品を追加</button>
          <button id="selectAllBtn" class="select-all-btn" disabled>全て選択</button>
          <button id="clearAllBtn">選択解除</button>
          <button id="exportBtn">選択した商品をCSVで出力</button>
          <button id="deleteSelectedBtn" class="danger-btn">選択商品を削除</button>
        </div>
      </div>
      
      <!-- 右半分下部：商品一覧 -->
      <div id="productListContainer">
        <div id="imageContainer"></div>
      </div>
    </div>
  </div>

  <!-- 商品追加モーダル -->
  <div id="productAdditionModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="closeProductAdditionModal()">&times;</span>
      <h2>商品追加</h2>
      <div id="modalShelfInfo"></div>
      
      <div class="input-method-selection">
        <label>入力方法:</label>
        <input type="radio" id="methodHandy" name="inputMethod" value="handy" checked>
        <label for="methodHandy">csv取り込み（スキャンチェックリスト）</label>
        <input type="radio" id="methodManual" name="inputMethod" value="manual">
        <label for="methodManual">JAN手入力</label>
      </div>
      
      <div id="handyTerminalInput" class="input-section">
        <h3>csv取り込み</h3>
        <input type="file" id="handyCSVFile" accept=".csv" style="display: none;">
        <button id="importCSVBtn">取り込む</button>
      </div>
      
      <div id="manualInput" class="input-section" style="display: none;">
        <h3>手動入力（13桁未満のJANは、頭に０を付けて13桁にしてください）</h3>
        <div>
          <label for="manualJAN">JANコード:</label>
          <input type="text" id="manualJAN" placeholder="13桁の数字 (例: 0000000000001)" pattern="\d{13}" maxlength="13" title="13桁の数字で入力してください">
          <button id="addManualJANBtn">追加</button>
        </div>
      </div>
      
      <div id="additionList">
        <h3>追加予定商品リスト</h3>
        <ul id="additionListItems"></ul>
        <button id="registerProductsBtn" style="margin-top: 10px;">商品登録</button>
      </div>
    </div>
  </div>

  <script src="viewer_core.js"></script>
  <script>
  // Register a minimal Service Worker to discourage browser caching
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function(){
      navigator.serviceWorker.register('./sw.js').catch(function(e){ /* noop */ });
    });
  }
  </script>

  <!-- ✅ iPadスキャナ自動反映（手入力タブ用） -->
  <script>
  (function(){
    'use strict';
    // 対象：手入力タブの入力欄と「追加」ボタン
    const inputEl = document.getElementById('manualJAN');
    const addBtn  = document.getElementById('addManualJANBtn');
    if (!inputEl || !addBtn) return;

    // スキャン検知パラメータ
    const SCAN_IDLE_MS = 120;           // 入力静止時間で確定
    const MAX_SCAN_DURATION_MS = 2000;  // これを超えると手入力とみなす

    let buffer = '';
    let timer = null;
    let scanning = false;
    let scanStartAt = 0;

    // 数字だけ
    function digitsOnly(s){ return (s || '').replace(/\D+/g,''); }

    // EAN-13/EAN-8 チェック
    function isValidEAN(code){
      if(!/^\d+$/.test(code)) return false;
      if(code.length===13) return v13(code);
      if(code.length===8)  return v8(code);
      return false;
    }
    function v13(code){
      const base = code.slice(0,12).split('').map(Number);
      const cd = Number(code[12]);
      let sum = 0;
      for(let i=0;i<base.length;i++){
        const pos = i+1;
        sum += base[i]*(pos%2===0?3:1);
      }
      const calc = (10-(sum%10))%10;
      return calc===cd;
    }
    function v8(code){
      const base = code.slice(0,7).split('').map(Number);
      const cd = Number(code[7]);
      let sum = 0;
      for(let i=0;i<base.length;i++){
        const pos = i+1;
        sum += base[i]*(pos%2===1?3:1);
      }
      const calc = (10-(sum%10))%10;
      return calc===cd;
    }

    function reset(){
      buffer = '';
      scanning = false;
      scanStartAt = 0;
      if(timer){ clearTimeout(timer); timer=null; }
      inputEl.value = ''; // 無効入力は残さない
    }

    function commit(reason){
      const jan = digitsOnly(buffer);
      if(!jan){ reset(); return; }
      if((jan.length===13 || jan.length===8) && isValidEAN(jan)){
        // 既存の「追加」処理に合わせる：入力欄に値→ボタンclick
        inputEl.value = jan;
        addBtn.click();
        reset();
      }else{
        // 仕様：黙って破棄してクリア
        reset();
      }
    }

    function schedule(){
      if(timer) clearTimeout(timer);
      timer = setTimeout(()=>{
        const now = performance.now();
        if(scanning && (now - scanStartAt) <= MAX_SCAN_DURATION_MS){
          commit('idle');
        }else{
          reset();
        }
      }, SCAN_IDLE_MS);
    }

    // iOSでも安定する input を主軸に
    inputEl.addEventListener('input', ()=>{
      const val = String(inputEl.value || '');
      const hasTerm = /[\r\n\t]$/.test(val);
      if(!scanning){
        scanning = true;
        scanStartAt = performance.now();
        buffer = '';
      }
      buffer += val;

      if(hasTerm){
        buffer = buffer.replace(/[\r\n\t]+/g,'');
        commit('term');
      }else{
        schedule();
      }
    });

    // Enter/Tab のkeydownも保険で拾う
    inputEl.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key==='Tab'){
        e.preventDefault();
        if(!scanning){
          scanning = true;
          scanStartAt = performance.now();
        }
        buffer += String(inputEl.value || '');
        commit('keydown:'+e.key);
      }
    });

    // change はPC互換の保険
    inputEl.addEventListener('change', ()=>{
      if(!scanning){
        scanning = true;
        scanStartAt = performance.now();
      }
      buffer += String(inputEl.value || '');
      commit('change');
    });

    // ペースト対応（運用保険）
    inputEl.addEventListener('paste', (e)=>{
      const txt = (e.clipboardData && e.clipboardData.getData('text')) || '';
      if(txt){
        e.preventDefault();
        inputEl.value = txt;
        scanning = true;
        scanStartAt = performance.now();
        buffer = txt;
        commit('paste');
      }
    });

    // iPadで数字キーボードを出しやすく
    inputEl.setAttribute('inputmode','numeric');
    inputEl.addEventListener('beforeinput',(e)=>{
      if(e.data && /\D/.test(e.data)){
        e.preventDefault();
      }
    });
  })();
  </script>
</body>
</html>
